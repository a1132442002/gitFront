<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
        <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
        <title>我的收藏</title>
        <link rel="icon" href="/assets/img/favicon.ico">
        <script src="./js/vue/vue.js"></script>
        <script src="./js/axios.min.js"></script>
        <script src="./js/common.js"></script>
        <link rel="stylesheet" type="text/css" href="css/webbase.css"/>
        <link rel="stylesheet" type="text/css" href="css/pages-seckillOrder.css"/>
    </head>

    <body>
        <div id="favoriteApp">
             <div id="nav-bottom">
                <ly-top/>
            </div>
<!--            <div class="top">
                <shortcut/>
            </div>
        &lt;!&ndash;页面顶部白条条，由js动态加载&ndash;&gt;
        <div class="nav-bottom"></div>
        <script type="text/javascript" src="plugins/jquery/jquery.min.js"></script>
        <script type="text/javascript">$(".nav-bottom").load("top.html");</script>

        <script type="text/javascript" src="js/plugins/jquery/jquery.min.js"></script>
        <script type="text/javascript">
            $(function () {
                $("#service").hover(function () {
                    $(".service").show();
                }, function () {
                    $(".service").hide();
                });
                $("#shopcar").hover(function () {
                    $("#shopcarlist").show();
                }, function () {
                    $("#shopcarlist").hide();
                });

            })
        </script>
        <script type="text/javascript" src="js/plugins/jquery.easing/jquery.easing.min.js"></script>
        <script type="text/javascript" src="js/plugins/sui/sui.min.js"></script>
        <script type="text/javascript" src="js/plugins/jquery-placeholder/jquery.placeholder.min.js"></script>
        <script type="text/javascript" src="js/widget/nav.js"></script>-->

            <!--header-->
            <div id="account">
                <div class="py-container">
                    <div class="yui3-g collect">
                        <!--左侧列表-->
                        <div class="yui3-u-1-6 list">

                            <div class="person-info">
                                <div class="person-photo"><img src="img/_/photo.png" alt=""></div>
                                <div class="person-account">
                                    <span class="name">Michelle</span>
                                    <span class="safe">账户安全</span>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                            <div class="list-items">
                                <dl>
                                    <dt><i>·</i> 订单中心</dt>
                                    <dd><a href="home-index.html">我的订单</a></dd>
                                    <dd><a href="home-order-pay.html">待付款</a></dd>
                                    <dd><a href="home-order-send.html">待发货</a></dd>
                                    <dd><a href="home-order-receive.html">待收货</a></dd>
                                    <dd><a href="home-order-evaluate.html">待评价</a></dd>
                                </dl>
                                <dl>
                                    <dt><i>·</i> 我的中心</dt>
                                    <dd><a href="home-person-collect.html" class="list-active">我的收藏</a></dd>
                                    <dd><a href="home-person-footmark.html">我的足迹</a></dd>
                                </dl>
                                <dl>
                                    <dt><i>·</i> 物流消息</dt>
                                </dl>
                                <dl>
                                    <dt><i>·</i> 设置</dt>
                                    <dd><a href="home-setting-info.html">个人信息</a></dd>
                                    <dd><a href="home-setting-address.html">地址管理</a></dd>
                                    <dd><a href="home-setting-safe.html">安全管理</a></dd>
                                </dl>
                            </div>
                        </div>
                        <!--右侧主内容-->
                        <div class="yui3-u-5-6 goods">
                            <div class="body">
                                <h4>收藏的商品</h4>
                                <div class="goods-list">
                                    <ul class="yui3-g" id="goods-list">
                                        <li class="yui3-u-1-4" v-for="favorite in myFavorites">
                                            <div class="list-wrap">
                                                <div class="p-img"><a :href="'/item/'+favorite.spuId+'.html'" target="_blank"><img :src="favorite.image" alt=""></a></div>
                                                <div class="price"><strong><em>¥</em>
                                                    <i>{{ly.formatPrice(favorite.newPrice)}}</i></strong>
                                                </div>
                                                <div style="color: #bf360c;padding-left: 15px;"
                                                     v-if="favorite.newPrice < favorite.price &&favorite.downMsg"
                                                     v-text="'比加入时便宜：￥' + ly.formatPrice(favorite.price - favorite.newPrice)"></div>
                                                <div class="attr" style="overflow: hidden;white-space:nowrap;">
                                                    <em>{{favorite.fullTitle}}</em>
                                                </div>
                                                <div class="cu" style="overflow: hidden;white-space:nowrap;">
                                                    <em><span>促</span>{{favorite.subTitle}}</em>
                                                </div>

                                                <div class="operate">
                                                    <a href="#" @click.prevent="addCart(favorite)" target="_blank"
                                                       class="sui-btn btn-bordered btn-danger">加入购物车</a>
                                                    <a href="javascript:void(0);" class="sui-btn btn-bordered">对比</a>
                                                    <a href="#" @click.prevent="downMsg(favorite.spuId)" target="_blank"
                                                       class="sui-btn btn-bordered">{{favorite.downMsg?"已开启":"降价通知"}}</a>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>

                                <!--猜你喜欢-->
                                <div class="like-title">
                                    <div class="mt">
                                        <span class="fl"><strong>猜你喜欢</strong></span>
                                    </div>
                                </div>
                                <div class="like-list">
                                    <ul class="yui3-g">
                                        <li class="yui3-u-1-4">
                                            <div class="list-wrap">
                                                <div class="p-img">
                                                    <img src="img/_/itemlike01.png"/>
                                                </div>
                                                <div class="attr">
                                                    <em>DELL戴尔Ins 15MR-7528SS 15英寸 银色 笔记本</em>
                                                </div>
                                                <div class="price">
                                                    <strong>
                                                        <em>¥</em>
                                                        <i>3699.00</i>
                                                    </strong>
                                                </div>
                                                <div class="commit">
                                                    <i class="command">已有6人评价</i>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="yui3-u-1-4">
                                            <div class="list-wrap">
                                                <div class="p-img">
                                                    <img src="img/_/itemlike02.png"/>
                                                </div>
                                                <div class="attr">
                                                    <em>Apple苹果iPhone 6s/6s Plus 16G 64G 128G</em>
                                                </div>
                                                <div class="price">
                                                    <strong>
                                                        <em>¥</em>
                                                        <i>4388.00</i>
                                                    </strong>
                                                </div>
                                                <div class="commit">
                                                    <i class="command">已有700人评价</i>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="yui3-u-1-4">
                                            <div class="list-wrap">
                                                <div class="p-img">
                                                    <img src="img/_/itemlike03.png"/>
                                                </div>
                                                <div class="attr">
                                                    <em>DELL戴尔Ins 15MR-7528SS 15英寸 银色 笔记本</em>
                                                </div>
                                                <div class="price">
                                                    <strong>
                                                        <em>¥</em>
                                                        <i>4088.00</i>
                                                    </strong>
                                                </div>
                                                <div class="commit">
                                                    <i class="command">已有700人评价</i>
                                                </div>
                                            </div>
                                        </li>
                                        <li class="yui3-u-1-4">
                                            <div class="list-wrap">
                                                <div class="p-img">
                                                    <img src="img/_/itemlike04.png"/>
                                                </div>
                                                <div class="attr">
                                                    <em>DELL戴尔Ins 15MR-7528SS 15英寸 银色 笔记本</em>
                                                </div>
                                                <div class="price">
                                                    <strong>
                                                        <em>¥</em>
                                                        <i>4088.00</i>
                                                    </strong>
                                                </div>
                                                <div class="commit">
                                                    <i class="command">已有700人评价</i>
                                                </div>
                                            </div>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">

            var vm = new Vue({
                el: "#favoriteApp",
                data: {
                    ly,
                    myFavorites: [],
                },
                created() {
                    // 判断是否登录 此时已经有商品分页数据，如果用户已登录则获取该用户下所有的收藏spuId
                    ly.http.get("/favorite/list").then((resp) => {
                        this.myFavorites = resp.data || [];
                        console.log(this.myFavorites);
                        const ids = this.myFavorites.map(f => {
                            f.saleable = false;
                            return f.skuId;
                        });
                        ly.http.get("/item/sku/list?ids=" + ids.join(",")).then(({data: skus}) => {
                            this.myFavorites.forEach(f => {
                                const sku = skus.find(s => s.id === f.skuId);
                                if (sku) {
                                    f.newPrice = sku.price;
                                }
                            });
                            //采用一种可以改变对象地址的方式给myFavorites赋值
                            const [...newMyFavorites] = this.myFavorites;
                            this.myFavorites = newMyFavorites;

                        }).catch(() => {
                        })
                    }).catch(() => {
                        //如果未登录，跳转到登录页面，
                        window.location.href = "http://www.leyou.com/login.html?returnUrl=" + window.location.href;
                    })
                },
                methods: {
                    addCart(favorite) {
                        // 判断是否登录
                        ly.http.get("/auth/verify").then(() => {
                            // 已登录
                            ly.http.post("/cart", {
                                skuId: favorite.skuId,
                                title: favorite.fullTitle,
                                image: favorite.image,
                                price: favorite.price,
                                num: 1,
                                ownSpec: JSON.stringify(this.ownSpec)
                            }).then(() => {
                                // 跳转到购物车列表页
                                window.location.href = "http://www.leyou.com/cart.html";
                            }).catch(() => {
                                alert("添加购物车失败，请重试！");
                            })
                        }).catch(() => {
                            //收藏夹入口加入购物车 未登录应该直接跳转登录界面
                            window.location.href = "http://www.leyou.com/login.html?returnUrl=" + window.location.href;
                        })
                    },
                    downMsg(spuId) {
                        // 判断是否登录
                        ly.http.get("/auth/verify").then(() => {
                            ly.http.put("/favorite/downMsg?spuId=" + spuId).then((resp) => {
                                console.log(resp.data);
                                console.log(this.myFavorites);
                                this.myFavorites.forEach(favorite => {
                                    if (favorite.spuId == spuId) {
                                        favorite.downMsg = resp.data;
                                    }
                                });
                            })
                        }).catch(() => {
                            // 未登录应该直接跳转登录界面
                            window.location.href = "http://www.leyou.com/login.html?returnUrl=" + window.location.href;
                        })
                    }
                },
                components: {
                    lyTop: () => import("./js/pages/top.js"),
                }


            })
        </script>

        <!-- 底部栏位 -->
        <!--页面底部，由js动态加载-->
        <div class="clearfix footer"></div>
        <script type="text/javascript"> $(".footer").load("foot.html");</script>
        <!--页面底部END-->

    </body>
</html>
